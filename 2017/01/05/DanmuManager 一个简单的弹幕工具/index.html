<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> DanmuManager 一个简单的弹幕工具 · CHENG KANG</title><meta name="description" content="DanmuManager 一个简单的弹幕工具 - 程康·Ant"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/progrant" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/cheng-kang" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">DanmuManager 一个简单的弹幕工具</h1><div class="post-time">Jan 5, 2017</div><div class="post-content"><blockquote>
<p>项目首页： <a href="https://github.com/cheng-kang/DanmuManager" target="_blank" rel="external">DanmuManager Github Repository</a></p>
</blockquote>
<h2 id="使用方法-Usage"><a href="#使用方法-Usage" class="headerlink" title="使用方法 Usage"></a>使用方法 Usage</h2><p><code>DanmuManager</code> 和 <code>VideoDanmuManager</code> 有不同的应用场景，后者用于视频弹幕。</p>
<p>你可以运行项目中的测试，来了解二者的使用方法。</p>
<h3 id="DanmuManager"><a href="#DanmuManager" class="headerlink" title="DanmuManager"></a>DanmuManager</h3><ol>
<li><p>创建 DanmuManager</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">let dm = DanmuManager(with: self.view)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<pre><code>初始化 `init` 方法允许自定义： 

- `top`、`bottom`弹幕显示在 `view` 中的上下位置范围;
- `speed` 弹幕的速度;
- `customFont` 弹幕字体（`UIFont`, 包括字体家族和大小，默认为系统字体，字号 20）。
</code></pre><ol>
<li><p>添加一条弹幕 </p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dm.add(with: “Wow so cool!!!”, at: 4)</span><br></pre></td></tr></table></figure>
<p> 添加弹幕 <code>add</code> 方法有两个必传参数，<code>text</code>（弹幕文字） 和 <code>line</code>（弹幕所在行）;可选参数 <code>hasBorder</code> 用于设置该条弹幕是否有边框（默认 borderColor = UIColor.black.cgColor，borderWidth = 1）,默认值为 false;可选参数 <code>isAdvance</code> 用于设置该条弹幕是否开启高级功能（目前支持修改 文字颜色 和 背景颜色），默认值为 false。</p>
<p> 如果需要弹幕出现在随机行，可以使用</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func addRandom(with text: String = &quot;This is a test Danmu.&quot;, at line: Int = 0, hasBorder: Bool = false, isAdvanced: Bool = false)`。</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p>暂停/继续 弹幕</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dm.pause()</span><br><span class="line">dm.resume()</span><br></pre></td></tr></table></figure>
</li>
</ol>
<pre><code>你也可以使用 `dm.toggle()` 来快捷切换 暂停/继续。
</code></pre><h3 id="VideoDanmuManager"><a href="#VideoDanmuManager" class="headerlink" title="VideoDanmuManager"></a>VideoDanmuManager</h3><ol>
<li><p>创建 VideoDanmuManager</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">let vdm = VideoDanmuManager(view: self.view,</span><br><span class="line">                               videoLength: 10,</span><br><span class="line">                               danmuData: [</span><br><span class="line">                                   (3.4, &quot;3.4 Wowowowowowow!&quot;),</span><br><span class="line">                                   (3.4, &quot;3.4 SOOOO COOOOOOOOOOL!&quot;),</span><br><span class="line">                                   (3.4, &quot;3.4 Amazing!!!!&quot;),</span><br><span class="line">                                   (3.4, &quot;3.4 I love you~&quot;),</span><br><span class="line">                                   (3.4, &quot;3.4 MY BABY!!!!&quot;),</span><br><span class="line">                                   (1.1, &quot;1.1 This is a test Danmu!!!&quot;),</span><br><span class="line">                                   (2.0, &quot;2.0 Another test Danmu.&quot;),</span><br><span class="line">                                   (4.1, &quot;4.1 Amazing!!!!&quot;),</span><br><span class="line">                                   (6.1, &quot;6.1 Test!!!!&quot;),</span><br><span class="line">                                   (8.1, &quot;8.1 Test!!!!&quot;),</span><br><span class="line">                                   (9.1, &quot;9.1 Test!!!!&quot;),</span><br><span class="line">                                   (10, &quot;10 Test!!!!&quot;),</span><br><span class="line">           ],</span><br><span class="line">                               isSorted: false</span><br><span class="line">       )</span><br></pre></td></tr></table></figure>
</li>
</ol>
<pre><code>`VideoDanmuManager` 的创建有三个必选参数，`view`（显示弹幕的视图），`videoLength`（视频时长，精确到 0.1 秒）和 `danmuData`（已经存在的弹幕列表）。

可选参数 `videoCurrent` 默认为 0，即开始时刻；你可以通过传入不同的时间值来设置显示弹幕的初始时间（比如在视频从 1 分 15 秒开始播放，则应设置 `videoCurrent` 为 75）。
可选参数 `isSorted` 默认为 true，即默认数据集已经按照弹幕显示时间从先到后排序；如传入 false，则将自动调用 `func sort()` 对数据进行排序。

可选参数 `top` 和 `bottom` 同 `DanmuManager`。
</code></pre><ol>
<li><p>开启弹幕</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vdm.start()</span><br></pre></td></tr></table></figure>
</li>
</ol>
<pre><code>你需要在视频开始播放的同时，手动开启弹幕。
</code></pre><ol>
<li><p>暂停/继续 弹幕</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vdm.pause()</span><br><span class="line">vdm.resume()</span><br></pre></td></tr></table></figure>
</li>
</ol>
<pre><code>你也可以使用 `vdm.toggle()` 来快捷切换 暂停/继续。
</code></pre><ol>
<li><p>中止弹幕</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vdm.stop()</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p>重新开始弹幕</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vdm.restart()</span><br></pre></td></tr></table></figure>
</li>
</ol>
<pre><code>你也可以在指定时间点重新开始弹幕：

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vdm.restart(at: 75)</span><br></pre></td></tr></table></figure>
</code></pre><h2 id="设计思路"><a href="#设计思路" class="headerlink" title="设计思路"></a>设计思路</h2><p><code>DanmuManager</code> 通过设置的字体大小计算文本显示高度 <code>lineHeight</code>，通过 <code>numberOfLines = Int(floor((bottom - top) / lineHeight))</code> 得到可以显示的弹幕行数；使用 <code>inUsingLines</code>，<code>enteringTimers</code> 和 <code>waitingQueues</code> 来分别记录 正在使用的行（有尾部还没有完全进入视图的弹幕的行），正在进入视图的弹幕的计时器 和 正在等待进入的弹幕队列。</p>
<p>为了防止弹幕重叠，只有当 当前行中前一条弹幕尾部进入视图 时（之后），下一条弹幕才可以发射。</p>
<p><code>enteringTimers</code> 中每一个 Timer 都对应一条正在进入视图的弹幕，当计时器结束时，通过 NotificationCenter 发通知将该弹幕所在的行的状态更改为 false。</p>
<p>因为弹幕存在暂停状态，如果弹幕对应的 Timer 不同时暂停，将导致 弹幕所在行状态 提前更改为 false。为了解决这个问题，我参考他人的想法并改进后创建了 PauseableTimer，并在本项目中使用上了。我的另外一篇博客更详细地介绍了 <a href="http://chengkang.me/2017/01/05/PauseableTimer%20%E4%B8%80%E4%B8%AA%E5%8F%AF%E6%9A%82%E5%81%9C%E7%9A%84%E8%AE%A1%E6%97%B6%E5%99%A8/" target="_blank" rel="external">《PauseableTimer》</a>。</p>
<p>为了避免手动发射弹幕和自动发射队列中的弹幕出现冲突（弹幕重叠），所有弹幕通过 <code>taskTimer</code> 定时任务统一调度。</p>
<h2 id="下一步-Next-Step"><a href="#下一步-Next-Step" class="headerlink" title="下一步 Next Step"></a>下一步 Next Step</h2><p>现在流行的弹幕功能越来越复杂、高级，DanmuManager 只是完成了最基础的滚动文字弹幕功能。未来可能会学习常见的弹幕，添加一些更高级的功能，比如 对滚动弹幕的操作，居中弹幕 等。    </p>
</div></article></div></section><footer><div class="paginator"><a href="/2017/01/05/PauseableTimer 一个可暂停的计时器/" class="next">下一篇</a></div><div data-thread-key="2017/01/05/DanmuManager 一个简单的弹幕工具/" data-title="DanmuManager 一个简单的弹幕工具" data-url="http://cheng-kang.github.io/2017/01/05/DanmuManager 一个简单的弹幕工具/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"chengkang"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div id="disqus_thread"></div><script>var disqus_shortname = 'chengkang';
var disqus_identifier = '2017/01/05/DanmuManager 一个简单的弹幕工具/';
var disqus_title = 'DanmuManager 一个简单的弹幕工具';
var disqus_url = 'http://cheng-kang.github.io/2017/01/05/DanmuManager 一个简单的弹幕工具/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//chengkang.disqus.com/count.js" async></script><div class="copyright"><p>© 2016 - 2017 <a href="http://cheng-kang.github.io">程康·Ant</a>, unless otherwise noted.</p></div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-75274957-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "//hm.baidu.com/hm.js?ae1a81e6256aab436489ff79379d128d";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>