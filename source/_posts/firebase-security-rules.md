---
title: Firebase å®‰å…¨ä¸è§„åˆ™
date: 1970-01-01 
tags:
- Firebase
---
> Date: 2017-09-30 21:08:37

> åŸæ–‡é“¾æ¥ï¼š[Firebase Security & Rules](https://howtofirebase.com/firebase-security-rules-88d94606ce4a)

Firebase æ˜¯ä¸€ä¸ªå¯ä»¥ä»ä»»æ„å»ºç«‹è¿æ¥äº†çš„å®¢æˆ·ç«¯è®¿é—®çš„äº‘æ•°æ®åº“ã€‚å› ä¸ºä»»æ„å®¢æˆ·ç«¯éƒ½å¯ä»¥è¿æ¥åˆ°ä»»æ„ Firebase [æ•°æ®åº“]ï¼Œä½ **å¿…é¡»**åˆ¶å®šå®‰å…¨è§„åˆ™æ¥ä¿æŠ¤ä½ çš„æ•°æ®ã€‚å†™ä¸å¥½æ°å½“çš„å®‰å…¨è§„åˆ™ä¼šè®©ä½ æš´éœ²åœ¨æ”»å‡»ä¸­ã€‚ä¸è¿‡åˆ«ç€æ€¥ï¼ä½ é©¬ä¸Šå°±èƒ½å­¦åˆ°å¸®ä½ ç´§ç´§é”ä½ä½ çš„æ•°æ®çš„å…¨éƒ¨çŸ¥è¯†äº†ã€‚

ä¿æŒå®‰å…¨è§„åˆ™ç®€æ´ã€‚å®‰å…¨è§„åˆ™å¯èƒ½å˜å¾—è¿‡äºå¤æ‚ï¼Œå¹¶å¾ˆå¿«å˜å¾—ä¸å—æ§åˆ¶å¦‚æœä½ çš„æ•°æ®ç»“æ„ä¸å¤Ÿè®¾è®¡å……åˆ†çš„è¯ã€‚è¿™ç¯‡æ–‡ç« å±•ç¤ºäº†ä¸€äº›â€œæœ€ä½³â€å®è·µã€‚ä¼°è®¡ä½ ä¼šè®²å…¶ç•¥ä½œä¿®æ”¹å°±ç”¨åˆ°ä½ çš„ç”Ÿäº§åº”ç”¨ä¸­å»â€¦â€¦å¦‚æœä½ é€‰æ‹©é‡‡ç”¨è¿™äº›æ¨¡å¼ï¼Œè®°å¾—ä»”ç»†æƒ³æƒ³èƒŒåçš„å«ä¹‰å°±è¡Œã€‚ç¡®ä¿åœ¨ä½ å¼€å§‹æäº‹ä¹‹å‰ï¼Œè¯»äº†æ•´ç¯‡æ–‡ç« ä»¥åŠ[å®‰å…¨è§„åˆ™æ–‡æ¡£](https://firebase.google.com/docs/database/security/)å…¨æ–‡ã€‚

<!-- more -->

## å®‰å…¨è§„åˆ™æ˜¯åŸºäºèŠ‚ç‚¹çš„

å®‰å…¨è§„åˆ™ç”±ä¸€ä¸ªå•ç‹¬çš„ JSON å¯¹è±¡ç®¡ç†ï¼Œä½ å¯ä»¥åœ¨ä½ çš„å®æ—¶æ•°æ®åº“æ§åˆ¶å°ç¼–è¾‘æˆ–è€…ä½¿ç”¨ Firebase CLI [æ¥ç¼–è¾‘]ã€‚è¿˜æœ‰ä¸€ä¸ªé¢å¤–æƒŠå–œï¼Œå¦‚æœä½ çš„è§„åˆ™æ ¼å¼é”™è¯¯çš„è¯ï¼Œæ§åˆ¶å°å’Œ CLI ä¼šç»™ä½ è­¦å‘Šã€‚

è§„åˆ™å¯¹è±¡å¼€å§‹æ˜¯è¿™æ ·ï¼š

```
{ 
 "rules": 
  { 
    ".read": false,
    ".write": false
  }
}
```

è¿™ä¸ª JSON å¯¹è±¡çš„æ ¹èŠ‚ç‚¹å¿…é¡»å‘½åä¸º `rules`ã€‚`rules` èŠ‚ç‚¹é»˜è®¤ä¸å¯è¯»å†™ã€‚ä¸Šé¢çš„ç«‹å³æ˜¾å¼åœ°è®¾ç½®äº† `.read` å’Œ `.write` ä¸º `false`ï¼Œä½†æ˜¯ç•™ä¸ªç©ºç™½çš„è§„åˆ™ä¹Ÿä¼šæœ‰åŒæ ·çš„æ•ˆæœã€‚

## çº§è”è§„åˆ™

Firebase çº§è”è§„åˆ™æ˜¯è¿™æ ·çš„ï¼šæˆäºˆä¸€ä¸ªçˆ¶æ¯èŠ‚ç‚¹è¯»å†™æƒé™ä¼šåŒæ—¶æˆäºˆå…¶æ‰€æœ‰å­èŠ‚ç‚¹è¯»å†™æƒé™ã€‚

å†è¯´ä¸€éã€‚

Firebase çº§è”è§„åˆ™æ˜¯è¿™æ ·çš„ï¼šæˆäºˆä¸€ä¸ªçˆ¶æ¯èŠ‚ç‚¹è¯»å†™æƒé™ä¼šåŒæ—¶æˆäºˆå…¶æ‰€æœ‰å­èŠ‚ç‚¹è¯»å†™æƒé™ã€‚

è¿™é‡Œæœ‰ä¸ªå·¨å¤§çš„â€œå‘â€ï¼Œå³ä½¿æ˜¯å¯¹äºæœ‰ç»éªŒçš„ Firebase ç”¨æˆ·æ¥è¯´ä¹Ÿæ˜¯è¿™æ ·ã€‚è®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹ä¸ºä»€ä¹ˆ Firebase è¿™æ ·æ¥å¤„ç†ï¼Œä»¥åŠæˆ‘ä»¬å¯ä»¥å¦‚ä½•ç»•è¿‡è¿™ä¸ªé™åˆ¶ã€‚

é¦–å…ˆï¼ŒFirebase æœ¬è´¨ä¸Šè¦æ±‚è¿™æ ·çš„ä¸€ç§è¡Œä¸ºã€‚å¦‚æœä½ åœ¨ Firebase é‡Œé¢æŸ¥è¯¢ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä½ å°†å¾—åˆ°å…¶*æ‰€æœ‰*çš„å­èŠ‚ç‚¹ã€‚Firebase éå¸¸æ³¨é‡æ€§èƒ½è¡¨ç°ï¼Œå®ƒä¸ä¼šèŠ±æ—¶é—´æ¥åœ¨æ¯ä¸€ä¸ªå­èŠ‚ç‚¹ä¸Šå¥—ç”¨è§„åˆ™å¹¶ä¸”åšå‡ºå¯èƒ½çš„ä»çˆ¶æ¯èŠ‚ç‚¹ç§»é™¤çš„åŠ¨ä½œã€‚é‚£æ ·ä¼šå¤§å¤§å½±å“å…¶è¡¨ç°ã€‚

ç¬¬äºŒï¼Œä½ å¯ä»¥é€šè¿‡æ ¹æ®ä½ çš„æƒé™ç»“æ„æ¥ç»“æ„åŒ–ä½ çš„æ•°æ®ä»¥è½»æ˜“åœ°é¿å…è¿™äº›çº§è”è§„åˆ™çš„é—®é¢˜ã€‚å°†ä½ çš„æ•°æ®åµŒå¥—åœ¨è¿™æ ·å‘½åçš„é«˜çº§åˆ«çš„èŠ‚ç‚¹ä¸­ï¼Œæ¯”å¦‚ â€œadminâ€ã€â€œuserReadableâ€ã€â€œuserWritableâ€ æˆ–è€… â€œuserOwnedâ€ã€‚å°†æœ‰ç€ç±»ä¼¼å®‰å…¨éœ€æ±‚çš„å¯¹è±¡åˆ†ç»„åœ¨é«˜çº§åˆ«èŠ‚ç‚¹ä¸‹ä¼šæœ‰æ•ˆåœ°é™ä½ä½ éœ€è¦ç»´æŠ¤çš„å®‰å…¨è§„åˆ™æ•°é‡ã€‚

**å…³äºéªŒè¯è§„åˆ™å°çªé—¨ï¼š**æˆ‘ä»¬ä¹‹åä¼šè°ˆåˆ°éªŒè¯è§„åˆ™ã€‚éªŒè¯è§„åˆ™ç”¨äºé˜»æ­¢ç”¨äºçˆ¶æ¯èŠ‚ç‚¹å†™æƒé™çš„ç”¨æˆ·å†™å…¥å…¶å­èŠ‚ç‚¹ã€‚è¿™æ ·çš„è¯ï¼Œå½“ä½ æˆäºˆäº†å†™æƒé™ç»™ `userOwned/preferences/{uid}`ï¼Œä½ å¯ä»¥ç¼–å†™ä¸€æ¡éªŒè¯è§„åˆ™ï¼Œæ¯”å¦‚è¯´ `userOwned/preferences/{uid}/isAdmin`ï¼Œè¿™æ ·å°±å¯ä»¥é˜»æ­¢ç”¨æˆ·æ›´æ–° `isAdmin` è¿™ä¸ªå­èŠ‚ç‚¹ã€‚

è¿™ç§æ–¹æ³•ä¼šå¸¦æ¥ä¸€äº›åæœï¼ŒåŸºæœ¬ä¸Šä»»ä½•åœ¨ `userOwned/preferences/{uid}` çš„ `ref.set()` çš„æ“ä½œéƒ½ä¼šå¤±è´¥ï¼Œå› ä¸ºä½ ä¸èƒ½é‡å†™ `isAdmin` è¿™ä¸ªå­èŠ‚ç‚¹...ä½ éœ€è¦ä½¿ç”¨ `ref.update()` æ¥å•ç‹¬æ›´æ–°æ¯ä¸€ä¸ªå­èŠ‚ç‚¹ã€‚å°† `isAdmin` èŠ‚ç‚¹ç§»åˆ°ä½ çš„æ•°æ®ç»“æ„çš„å…¶ä»–æœ¬å°±æ˜¯ç”¨æˆ·å¯è¯»ä¸å¯å†™çš„éƒ¨åˆ†ä¼šæ¯”è¾ƒè½»æ¾ã€‚ä½ å¯ä»¥å°†å…¶å‘½åä¸º `userReadable/preferences/{uid}/isAdmin`ã€‚

## ç¤ºä¾‹æ•°æ®ç»“æ„

æˆ‘ä»¬å°†ä½¿ç”¨ä»¥ä¸‹æ•°æ®ç»“æ„æ¥ç»§ç»­å‰©ä¸‹çš„å†…å®¹ï¼š

```
{
  "users": {
    "kanyesUID": {
      "name": "Kanye West",
      "email": "kwest@gmail.com"
    },
    "taylorsUID": {
      "name": "Taylor Swift",
      "email": "tswift@gmail.com"
    },
    "seacrestsUID": {
      "name": "Ryan Seacrest",
      "email": "rseacrest@gmail.com",
      "isAdmin": true
    }
  },
  "userReadable": {
    "tweets": {
      "kanyesUID": {
        "aPushKey": {
          "text": "Imma let you finish, but..."
        },
        "bPushKey": {
          "text": "Queen B shoulda received this award..."
        }
      }
    },
    "retweets": {
      "taylorsUID": {
        "cPushKey": {
          "key": "aPushKey",
          "text": "Imma let you finish, but..."
        },
        "dPushKey": {
          "key": "bPushKey",
          "text": "Queen B shoulda received this award..."
        }
      }
    }
  },
  "userWriteable": {
    "tweetQueue": {
      "taylorsUID": {
        "text": "I ğŸ’• you all like Kanye ğŸ’•'s Kanye"
      }
    }
  },
  "userOwned": {
    "preferences": {
      "kanyesUID": {
        "loveKanye": true
      },
      "taylorsUID": {
        "listenToHaters": false
      }
    }
  }
}
```

è¿™äº›æ•°æ®æœ‰å››ä¸ªé¡¶çº§èŠ‚ç‚¹ï¼š

1. users
2. userReadable
3. userWriteable
4. userOwned

æˆ‘ä»¬æœ‰ä¸¤ä¸ªç”¨æˆ·ï¼š

1. Kanye West
2. Taylor Swift

`users` èŠ‚ç‚¹åŒ…å«äº†åŸºç¡€çš„ç”¨æˆ·æ•°æ®ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­å°±æ˜¯é‚®ç®±åœ°å€ã€‚æˆ‘ä»¬è®¾æƒ³å½“ Kanye ç™»é™†äº†æˆ‘ä»¬çš„ appï¼Œä»–çš„ uid æ˜¯ `kanyesUID`ã€‚ç±»ä¼¼çš„ï¼ŒTaylor å¾—åˆ°äº†è¿™ä¸ª uid `taylorsUID`ã€‚è¿™äº› UID ä¼šç»„æˆæˆ‘ä»¬å®‰å…¨æ¨¡å‹çš„åŸºç¡€ã€‚

é¦–å…ˆï¼Œæ¥è®©æ¯ä¸ªç”¨æˆ·æ•°æ®`ç”¨æˆ·å¯è¯»`...

```
{
 "rules": {
    "users": {
      "$uid": {
        ".read": "auth.uid == $uid"
      }
    }
  }
}
```

æˆ‘ä»¬åœ¨æ ¹èŠ‚ç‚¹ `rules` ä¸ŠåŠ äº†ä¸€ä¸ª `users` èŠ‚ç‚¹ã€‚ä»»ä½•ç›´æ¥å†™åœ¨ `users` èŠ‚ç‚¹ä¸‹é¢çš„è§„åˆ™ä¼šè¢«åº”ç”¨åˆ°æ‰€æœ‰å…¶å­èŠ‚ç‚¹ä¸­...ä½†æ˜¯æˆ‘ä»¬å¹¶ä¸æƒ³åœ¨ `users` èŠ‚ç‚¹ä¸Šè®¾ç½®è§„åˆ™ã€‚æˆ‘ä»¬å¸Œæœ›ç»™æ¯ä¸€ä¸ªç‹¬ç«‹çš„ç”¨æˆ·åŸºäºå…¶ uid è®¾ç½®è§„åˆ™ï¼Œå› æ­¤æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªé€šé…èŠ‚ç‚¹ï¼Œ`$uid`ã€‚æˆ‘ä»¬å¯ä»¥éšæ„å‘½åé€šé…èŠ‚ç‚¹ï¼Œåªè¦å…¶å¼€å§‹å­—ç¬¦æ˜¯ `$`ã€‚æœ€ä½³å®è·µæ˜¯ç»™ä»–ä»¬å‘½åä¸€äº›æè¿°æ€§çš„ä¸œè¥¿ï¼Œå› æ­¤æˆ‘ä»¬å°†è¿™ä¸ªé€šé…èŠ‚ç‚¹å‘½åä¸º `$uid`ï¼Œå› ä¸ºæ¯ä¸ªç”¨æˆ·éƒ½å°†ä¿å­˜åœ¨å…¶ uid ä¸‹ã€‚

é€šé…èŠ‚ç‚¹åº”ç”¨äºæ‰€æœ‰å…¶ä»–æ²¡æœ‰æ˜ç¡®æŒ‡å‡ºçš„èŠ‚ç‚¹ä¸Šã€‚æœ‰ç‚¹ç³Šæ¶‚äº†ï¼Ÿçœ‹çœ‹è¿™ä¸ªã€‚

```
{
  "rules": {
    "users": {
      "$uid": {
        ".read": "auth.uid == $uid"
      },
      "taylorsUID": {
        ".read": "auth.uid == 'taylorsUID'",
        ".write": "auth.uid == 'taylorsUID'"
      }
    }
  }
}
```

çœ‹åˆ°æˆ‘ä»¬å¹²äº†å•¥å—ï¼Ÿæˆ‘ä»¬ä»…èµ‹äºˆäº† `$uid` èŠ‚ç‚¹ `.read` æƒé™ï¼Œä½†æ˜¯æˆ‘ä»¬ç»™äº† Taylor è¿™ä¸ªç”¨æˆ· `.read` å’Œ `.write` æƒé™ã€‚

ä½ å¯èƒ½åœ¨æƒ³ `auth.uid == $uid` æ˜¯ä»€ä¹ˆæ„æ€ã€‚å½“ç”¨æˆ·é€šè¿‡ Firebase Authentication è®¤è¯æˆåŠŸæ—¶ï¼Œè¿™ä¸ªç”¨æˆ·ä¼šä»ç³»ç»Ÿè·å¾—ä¸€ä¸ª uidï¼Œå®ƒå¯ä»¥é€šè¿‡ `auth.uid` è®¿é—®åˆ°ã€‚å› æ­¤å½“ Kanye åœ¨ç³»ç»Ÿä¸­è®¤è¯æ—¶ï¼Œä»–çš„ `auth.uid` ç­‰äº `kanyesUID`ã€‚æˆ‘ä»¬å¯ä»¥å°† `auth.uid` å’Œ `$uid` æ¯”è¾ƒæ¥æˆäºˆç”¨æˆ·å¯¹ä»–ä»¬è‡ªå·±èŠ‚ç‚¹çš„è¯»æƒé™ï¼Œä½†å¯¹å…¶ä»–èŠ‚ç‚¹æ— æƒé™ã€‚ä¹Ÿå¯ä»¥ç›´æ¥å’Œå­—ç¬¦ä¸²æ¯”è¾ƒï¼š`".read": "auth.uid == 'taylorsUID'"`ã€‚

## ç´¢å¼•å­é”®æ¥åŠ å¿«æŸ¥è¯¢

è®¾æƒ³æˆ‘ä»¬çš„ app åœ¨è¿›è¡Œè¿™æ ·ä¸€ä¸ªæŸ¥è¯¢ï¼š

```
ref.child('users').orderByChild('email').equalTo('kwest@gmail.com').once('value', callback);
```

æˆ‘ä»¬åœ¨è¦æ±‚ firebase æ¥ä» `users` èŠ‚ç‚¹ä¸­æœç´¢ä¸€ä¸ª `email` èŠ‚ç‚¹ä¸º `kwest@gmail.com` çš„å­èŠ‚ç‚¹ã€‚æ ¹æ®æˆ‘ä»¬æ•°æ®åº“çš„å¤§å°ï¼Œè¿™å¯èƒ½æ˜¯ä¸€ä¸ªéå¸¸å·¨é‡ä¸”ç¼“æ…¢çš„æŸ¥è¯¢ï¼Œå› æ­¤ Firebase ç»™æˆ‘ä»¬æä¾›äº†æŒ‡å®šå­èŠ‚ç‚¹çš„é«˜æ€§èƒ½ç´¢å¼•ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ› Firebase é€šè¿‡ `email` è¿™ä¸ªå­èŠ‚ç‚¹ç´¢å¼•æ‰€æœ‰ç”¨æˆ·ã€‚åšæ³•å¾ˆç®€å•ï¼Œ`".indexOn": "email"`ã€‚å¦‚ä¸‹ï¼š

```
{
  "rules": {
    "users": {
      "$uid": {
        ".read": "auth.uid == $uid",
        ".indexOn": [
          "email"
        ]
      }
    }
  }
}
```

å¦‚æœæˆ‘ä»¬è¿˜è¦ç´¢å¼•å…¶ä»–å­èŠ‚ç‚¹ï¼Œæ¯”å¦‚è¯´ `users/{$user}/username`ï¼Œæˆ‘ä»¬çš„è§„åˆ™å°±è¿™ä¹ˆå†™ `".indexOn": ["email", "username"]`ã€‚

## éå†æ ‘ä»¥è·å–ç»†èŠ‚æƒé™

è®©æˆ‘ä»¬å°†è¿™ä¸ªè®¾æƒ³çš„ç±»ä¼¼ twitter çš„ app çš„ç¬¬ä¸‰ä¸ªç”¨æˆ·ç§°ä¸ºï¼š Ryan Seacrestã€‚Ryan çš„è´¦å·æ˜¯ç®¡ç†å‘˜è´¦å·ã€‚æ³¨æ„åˆ°äº†ä»–çš„ç”¨æˆ·è´¦å·é‡Œçš„ `"isAdmin": true` å±æ€§äº†å—ï¼Ÿ

```
{
  "rules": {
    "users": {
      "$uid": {
        ".read": "auth.uid == $uid || root.child('users').child(auth.uid).child('isAdmin').val() == true",
        ".write": "root.child('users').child(auth.uid).child('isAdmin').val() == true",
        ".indexOn": [
          "email"
        ]
      }
    }
  }
}
```

ç”¨æˆ·ä»¬ä»ç„¶å¯ä»¥è¯»å–ä»–ä»¬è‡ªå·±çš„è´¦æˆ·æ•°æ®ï¼Œä¸è¿‡æˆ‘ä»¬åˆšåˆšç»™æ‰€æœ‰æœ‰ `isAdmin` æ ‡è¯†çš„ç”¨æˆ·èµ‹äºˆäº†è¯»å†™æƒé™ã€‚ç”¨äºæ£€æµ‹è¿™ä¸ªæ ‡è¯†çš„è§„åˆ™æ˜¯ `root.child(â€˜usersâ€™).child(auth.uid).child(â€˜isAdminâ€™).val()`ã€‚`root` å¯¹è±¡ä»£è¡¨æˆ‘ä»¬çš„ Firebase çš„æ ¹èŠ‚ç‚¹ã€‚æ¥ç€æˆ‘ä»¬è°ƒç”¨ `.child('nodeName')` æ¥å‘ä¸‹æ‰¾åˆ°æˆ‘ä»¬çš„è®¤è¯è¿‡çš„ç”¨æˆ·çš„ `isAdmin` èŠ‚ç‚¹ã€‚çœ‹åˆ°äº†æ˜¯æ€ä¹ˆä½¿ç”¨ `auth.uid` æ¥æ·±å…¥åˆ°è¿™ä¸ªè®¤è¯ç”¨æˆ·çš„å—ï¼Ÿæ˜¯ï¼Œè¿™æ ·åšå¾ˆèªæ˜ã€‚å®ƒåŒæ—¶ä¹Ÿæ‚„æ‚„åœ°è®©ä»»ä½•æ²¡æœ‰è®¤è¯çš„ç”¨æˆ·è®¿é—®å¤±è´¥ï¼Œè¿™æ ·è¿™äº›èŠ‚ç‚¹å°±å®‰å…¨äº†ã€‚

è¿˜æœ‰ä¸€ç‚¹è¦æ³¨æ„ï¼šæˆ‘ä»¬åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Šè°ƒç”¨ `.val()` æ¥è·å–å®ƒçš„å€¼ã€‚è¿™è®©äººæƒ³èµ·æˆ‘ä»¬æ˜¯å¦‚ä½•ä½¿ç”¨ Firebase JavaScript SDK æ¥å¤„ç†æ•°æ®å¿«ç…§ï¼Œåº”è¯¥çœ‹èµ·æ¥å¾ˆç†Ÿæ‚‰å§ã€‚

å¦å¤–ä¸€ç‚¹ï¼šè¿˜æœ‰åˆ«çš„éå†æ ‘çš„æ–¹å¼ã€‚æˆ‘ä»¬å¯ä»¥è°ƒç”¨ `data.parent().child(auth.uid).val()` æ¥ä»æˆ‘ä»¬æ­£åœ¨ä¿æŠ¤çš„èŠ‚ç‚¹å¾€ä¸Šèµ°åˆ° `users` å†å¾€ä¸‹èµ°ã€‚è¿™ä¸ªæ–¹æ³•ä¼šå¾ˆå®ç”¨ï¼Œä½†æ˜¯ä» `root` å¼€å§‹éå†ä¼šæ›´å¯é ï¼Œå› ä¸º `root` å¯¹äºæˆ‘ä»¬ app çš„ä»»ä½•éƒ¨åˆ†éƒ½æ˜¯ä¸€æ ·çš„ã€‚ä¸ºäº†å®‰å…¨ï¼Œè¿˜æ˜¯ç”¨ `root` å§ã€‚

## ä½¿ç”¨ Bolt è§„åˆ™ç¼–è¯‘å™¨æ¥ streamline ä½ çš„è§„åˆ™

åˆ°ç›®å‰æˆ‘ä»¬ä¸€ç›´åœ¨ç›´æ¥ä¿®æ”¹æˆ‘ä»¬çš„è§„åˆ™ JSON å¯¹è±¡ã€‚è¿™æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯å®ƒå¯èƒ½æ€»æ˜¯åœ¨é‡å¤å¤åˆ¶ç²˜è´´æ“ä½œã€‚Firebase å›¢é˜Ÿä¹Ÿå·²ç»ç–²äºå¤åˆ¶ç²˜è´´ï¼Œäºæ˜¯å†™äº†ä¸€ä¸ªå’Œ [firebase-tools](https://github.com/firebase/firebase-tools) CLI ç»“åˆæ¥è®©è§„åˆ™æ›´å®¹æ˜“å†™çš„ç¼–è¯‘å™¨ã€‚

ä½ éœ€è¦é€šè¿‡ `npm install -g firebase-bolt` å®‰è£… Bolt å¹¶ä¸”åœ¨ä½ çš„é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºä¸€ä¸ªå‘½åä¸ºç±»ä¼¼ `security-rules.bolt` çš„æ–‡ä»¶ã€‚ç„¶åä½ å¯ä»¥æ‰§è¡Œ `firebase-bolt sevurity-rules.bolt`ï¼Œå®ƒä¼šç¼–è¯‘ä½ çš„ Bolt è§„åˆ™åˆ°ä¸€ä¸ªæ–°çš„æ–‡ä»¶å¹¶å‘½åä¸º `firebase-rules.json`ã€‚ç”Ÿæˆçš„ JSON å¯èƒ½ä¼šæ¯”æˆ‘ä»¬ä¹‹å‰å†™çš„ JSON æ›´å•°å—¦ï¼Œä½†æ˜¯ Bolt è¯­æ³•å¾ˆå¥½ç”¨ç²¾ç‚¼ã€‚è¯¦è§ [Bolt language reference](https://github.com/firebase/bolt/blob/master/docs/language.md)ã€‚

```
function isUser (auth, userKey) {
  return uid == userKey;
}

function isAdmin (auth) {
  return root.child('users').child(auth.uid).child('isAdmin').val() == true;
}

path /users/{uid} {
  read() { isUser(auth, uid) || isAdmin(auth) }
  write() { isAdmin(auth) }
  index() { ["email"] }
}

path /userReadable/{objectType}/{uid} {
  read() { isUser(auth, uid) || isAdmin(auth) }
  write() { isAdmin(auth) }
}

path /userWriteable/{objectType}/{uid} {
  read() { isAdmin(auth) }
  write() { isUser(auth, uid) || isAdmin(auth) }
}

path /userOwned/{objectType}/{uid} {
  read() { isUser(auth, uid) || isAdmin(auth) }
  write() { isUser(auth, uid) || isAdmin(auth) }
}
```

è¯·æ³¨æ„æˆ‘ä»¬æ˜¯æ€æ ·å†™åœ¨é¡¶éƒ¨çš„ä¸¤ä¸ªæ–¹æ³•çš„ï¼š`isUser(auth, uid)` å’Œ `isAdmin(auth)`ã€‚è¿™äº›æ–¹æ³•ä¸æ˜¯å¿…é¡»çš„ï¼Œä½†æ˜¯è¶…çº§æœ‰ç”¨ã€‚å®ƒä»¬è®©æˆ‘ä»¬å¯ä»¥åœ¨æˆ‘ä»¬çš„è§„åˆ™ä¸­é‡ç”¨ä¸€äº›é€»è¾‘ã€‚

ä¸‹ä¸€ä¸ªéƒ¨åˆ†æœ‰ä¸€å † `path` å—ã€‚ä½¿ç”¨ `/[nodeName]/` æ¥é€šé…ä½ çš„è·¯å¾„ã€‚è¿™äº›é€šé…å€¼åœ¨è¿™äº› path çš„èŒƒå›´å†…éƒ½æ˜¯å¯ç”¨çš„ï¼Œå› æ­¤ä½ å¯ä» `/userReadable/objectType/uid` è·å– `uid`ï¼Œå¹¶ä¼ ç»™ `read() { isUser(auth, uid) || isAdmin(auth) }`ã€‚

## æ ¹æ®è¯»å†™æƒé™æ¥ç»“æ„åŒ–ä½ çš„æ•°æ®

ä½ å¯èƒ½æ³¨æ„åˆ°äº†æœ‰ä¸‰ä¸ªé¡¶çº§èŠ‚ç‚¹è¢«å‘½åä¸ºï¼š

- userReadable
- userWriteable
- userOwned

ä¸Šä¸€èŠ‚ä¸­æˆ‘ä»¬æˆäºˆäº†ç”¨æˆ·è¯»æƒé™ç»™ `userReadable` çš„å­èŠ‚ç‚¹ã€å†™æƒé™ç»™ `userWriteable` çš„å­èŠ‚ç‚¹ä»¥åŠå®Œæ•´çš„è¯»å†™æƒé™ç»™ `userOwned` çš„å­èŠ‚ç‚¹ã€‚

è¿™æ˜¯åªä¸€ä¸ªéšæ„çš„æ•°æ®ç»“æ„â€¦æˆ‘ä»¬å¯ä»¥å°†è¿™ä¸‰ä¸ªèŠ‚ç‚¹å‘½åä¸ºéšä¾¿ä»€ä¹ˆã€‚ä¸è¿‡å‘½åä¸ºæè¿°æ€§çš„åå­—ä¼šæ›´å¥½ã€‚æ¥ç€æˆ‘ä»¬ç”¨äº†é€šé…è·¯å¾„ï¼ˆ`path/userReadable/objectType/uid`ï¼‰æ¥ç»™ä¸€ç»„ä¸€ç»„çš„å¯¹è±¡åº”ç”¨è§„åˆ™ã€‚

ç°åœ¨æˆ‘ä»¬ä¸éœ€è¦ç»™æˆ‘ä»¬åˆ›å»ºçš„æ¯ä¸€ç±»å¯¹è±¡éƒ½ç¼–å†™è§„åˆ™ã€‚æˆ‘ä»¬åªéœ€è¦å°†è¿™äº›å¯¹è±¡åµŒå¥—åœ¨æ°å½“çš„æƒé™èŠ‚ç‚¹ä¸‹å°±å¥½äº†ã€‚ä¾‹å¦‚ï¼š

```
{
  "rules": {
    "userOwned": {
      "preferences": {
        "kanyesUID": {
          "loveKanye": true
        },
        "taylorsUID": {
          "listenToHaters": false
        }
      }
    }
  }
}
```

`userOwned` èŠ‚ç‚¹æœ‰å¯¹æ‰€æœ‰åœ¨åŒ¹é…çš„ç”¨æˆ· uid ä¸‹çš„å¯¹è±¡çš„è¯»å†™æƒé™ã€‚å› æ­¤åªæœ‰ Kanye å¯ä»¥è®¿é—® `/userOwned/preferences/kanyesUID`ï¼Œå¹¶ä¸” Kanye æœ‰å®Œæ•´çš„è¯»å†™æƒé™ã€‚

è¦è®°å¾—æˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ¶å®šå¦ä¸€æ¡åŒ¹é…è·¯å¾„è§„åˆ™æ¥é‡å†™ç»Ÿé…è§„åˆ™ï¼Œä¾‹å¦‚ï¼š

```
path /userOwned/{objectType}/{uid} {
 read() { isUser(auth, uid) || isAdmin(auth) }
  write() { isUser(auth, uid) || isAdmin(auth) }
}
path /userOwned/grammyNominations/taylorsUID {
  read() { true }
  write() { uid == kanyesUID }
}
```

ç¬¬äºŒæ¡è§„åˆ™é‡å†™äº† `/userOwned/{objectType}/uid` å¹¶ä»…æˆäºˆ Kanye å¯¹äº Taylorâ€™s Grammy Nominations çš„å†™æƒé™ã€‚åŒæ—¶ä¹Ÿè®©è¿™ä¸ªåˆ—è¡¨å…¨ä¸–ç•Œå¯è¯»ï¼Œå› æ­¤ä»»ä½•ç½‘ç«™æˆ–è€…ç”¨æˆ·éƒ½å¯ä»¥é€šè¿‡ `https://<some firebase>.firebaseio.com/userOwned/grammyNominations/taylorsUID.json` æ¥è·å–è¿™ä¸ªåˆ—è¡¨ã€‚

## ä¿è¯å®‰å…¨æ€§çš„åŒæ—¶éªŒè¯ä½ çš„æ•°æ®

`read()`ã€`write()` ä»¥åŠ `index()` è¦†ç›–äº†å¤§å¤šæ•°ä½¿ç”¨æƒ…å†µï¼Œä½†æœ‰æ—¶å€™ä½ å¯èƒ½éœ€è¦æ›´å¤šå¯¹äºè¦å†™å…¥çš„æ•°æ®çš„æ›´ç»†èŠ‚çš„æ§åˆ¶ã€‚

Bolt å…è®¸ä½ åˆ›å»ºå¯ä»¥åœ¨å¤šèŠ‚ç‚¹é—´é‡ç”¨çš„æ•°æ®ç±»å‹ã€‚

```
path /userOwned/preferences/{uid} is Preferences;
type Preferences {
 validate() { this.excuse.length < 20 && this.respectRating < 5 }
  useAutotune: Boolean,
  excuse: String,
  respectRating: Number
}
```

è¯·æ³¨æ„ï¼Œæˆ‘ä»¬å¯ä»¥å°†éªŒè¯è§„åˆ™å’Œ `validate()` æ··åˆåœ¨ä¸€èµ·ã€‚

ä½ ä¹Ÿå¯ä»¥å°†ç±»å‹å’Œè¯»å†™æƒé™æ··åˆï¼š

```
path /userOwned/preferences/{uid} is Preferences {
 read() { isUser(auth, uid) }
 write() { isUser(auth, uid) }
}
type Preferences {
  validate() { this.excuse.length < 20 && this.respectRating < 5 }
  useAutotune: Boolean,
  excuse: String,
  respectRating: Number
}
```

## åˆ«åè§„åˆ™

ç›®å‰ä¸ºæ­¢æˆ‘ä»¬ä»…ä»…ä½¿ç”¨äº† `read()`ã€`write()`ã€`index()` å’Œ `validate()`ï¼Œä½†æ˜¯ Bolt æ”¯æŒå…¶å®ƒä¸‰ä¸ªåŠŸèƒ½ï¼š

- create()
- update()
- delete()

è¿™äº›æ–¹æ³•éƒ½æ˜¯ `write()` çš„åˆ«åï¼Œå› æ­¤ä»–ä»¬ä¸èƒ½å’Œ `write()` ä¸€èµ·æ··åˆåˆ°åŒä¸€ä¸ª `path` å—ã€‚å®ƒä»¬åˆ›å»ºäº†åˆ†åˆ«ä»…é€‚ç”¨äºæ–°å»ºã€æ›´æ–°æˆ–è€…åˆ é™¤æ“ä½œçš„ `write()` è§„åˆ™ã€‚ä¸‹é¢çš„ç¤ºä¾‹æ˜¯å¦‚æœä½ æƒ³è¦ç»™ç”¨æˆ·æƒé™åˆ›å»ºå¯¹è±¡ä½†æ˜¯ä¸èƒ½ç¼–è¾‘æˆ–è€…åˆ é™¤ï¼Œ`create()` ä¼šç”Ÿæˆå¤„ç†è¿™ç§æƒ…å†µçš„ `write()` è§„åˆ™ã€‚

```
path /dropbox/{objectType}/{uid} {
 create() { isUser(auth, uid) }
  read() { isAdmin(auth) }
}
 
path /editable/{objectType}/{uid} {
  update() { isUser(auth, uid) }
  read() { isAdmin(auth) }
}
 
path /deleteable/{objectType}/{uid} {
  delete() { isUser(auth, uid) }
  read() { isAdmin(auth) }
}
```

## éƒ¨ç½²ä½ çš„è§„åˆ™

æœ‰ä¸¤ç§æ–¹å¼ï¼š

1. æ‰§è¡Œ `firebase-bolt my-rules-file.bolt` æ¥åˆ›å»º `my-rules-files.json`ï¼Œç„¶åä½ å¯ä»¥å¤åˆ¶ç²˜è´´åˆ°ä½ çš„å®æ—¶æ•°æ®åº“è§„åˆ™æ§åˆ¶å°ã€‚
2. æ‰§è¡Œ `firebase-tools init` æ¥åˆ›å»ºä½ çš„ `firebase.json` æ‰˜ç®¡æ–‡ä»¶ï¼Œç„¶ååœ¨ `database.rules` åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹æ¥æŒ‡å‘ä½ çš„ `.bolt` æˆ–è€… â€˜.jsonâ€™ è§„åˆ™æ–‡ä»¶ã€‚æ¥ç€è¿è¡Œ `firebase deploy --only rules` æ¥é€šè¿‡å‘½ä»¤è¡Œéƒ¨ç½²ä½ çš„è§„åˆ™ã€‚

æˆ‘ä»¬ç¨åä¼šè°ˆåˆ° `firebase.json` è¿™ä¸ªé€‰é¡¹ã€‚ç°åœ¨ï¼Œçœ‹çœ‹ä¸‹é¢è¿™ä¸ª `firebase.sjon` ä¾‹å­å¹¶ä¸”ç•™æ„ `database.rules` è¿™ä¸ªèŠ‚ç‚¹ã€‚å®ƒæŒ‡å‘äº†ä¸€ä¸ªè®°å½•äº†æˆ‘çš„ bolt è§„åˆ™çš„å«åš `database.rules.bolt` çš„æ–‡ä»¶ã€‚å¦‚æœè¿™ä¸ªæ–‡ä»¶è¢«å‘½åä¸º `database.rules.json`ï¼Œfirebase ä¼šçŸ¥é“æˆ‘çš„è§„åˆ™æ˜¯ JSON æ ¼å¼ï¼Œä¸è¿‡å› ä¸ºæˆ‘å‘½åäº†ä¸º `.bolt`ï¼Œå®ƒä¼šåœ¨ä¸Šä¼ å…¶åˆ°æˆ‘çš„ Firebase äº‘ä¸Šä¹‹å‰è‡ªåŠ¨å°†å…¶ä¼ ç»™ `firebase-bolt` ç¼–è¯‘å™¨è¿›è¡Œç¼–è¯‘ã€‚

```
// Eample firebase.json
{
  "database": {
    "rules": "database.rules.bolt"
  },
  "hosting": {
    "public": "dist",
    "rewrites": [
      {
        "source": "/app/**/*",
        "destination": "/index.html"
      }
    ],
    "ignore": [
      "firebase.json",
      "**/.*",
      "**/node_modules/**"
    ]
  },
  "functions": {
    ".source": "functions"
  }
}
```


## ç»ƒä¹ 

å·®ä¸å¤šå°±è¿™æ ·äº†ã€‚

å…·ä½“ç»ƒä¹ è§åŸæ–‡å§ ï¼šDã€‚




























